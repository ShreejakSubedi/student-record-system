{% extends "base.html.twig" %}

{% block title %}Dashboard - Student Record Management System{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ðŸ‘¥</div>
            <div class="stat-content">
                <div class="stat-number">{{ students|length }}</div>
                <div class="stat-label">Total Students</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ðŸ“–</div>
            <div class="stat-content">
                <div class="stat-number">{{ grades|length }}</div>
                <div class="stat-label">Total Grades</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">ðŸ“‹</div>
            <div class="stat-content">
                <div class="stat-number">{{ attendance|length }}</div>
                <div class="stat-label">Attendance Records</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-content">
                <div class="stat-number">{{ active_students }}</div>
                <div class="stat-label">Active Students</div>
            </div>
        </div>
    </div>

    <!-- Quick Action Buttons -->
    <div class="quick-actions">
        <a href="/student-record-system/public/add_student.php" class="btn btn-primary">+ Add New Student</a>
        <a href="/student-record-system/public/add_grade.php" class="btn btn-success">+ Add Grade</a>
        <a href="/student-record-system/public/add_attendance.php" class="btn btn-info">+ Mark Attendance</a>
    </div>

    <!-- Students Table -->
    <div class="section">
        <h2>All Students</h2>
        {% if students|length > 0 %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Roll Number</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Class</th>
                        <th>Status</th>
                        <th>Avg Grade</th>
                        <th>Attendance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr>
                        <td>{{ student.roll_number }}</td>
                        <td>{{ student.first_name }} {{ student.last_name }}</td>
                        <td>{{ student.email }}</td>
                        <td>{{ student.phone ?? 'N/A' }}</td>
                        <td>{{ student.class }}</td>
                        <td>
                            <span class="badge badge-{{ student.status|lower }}">
                                {{ student.status }}
                            </span>
                        </td>
                        <td>
                            <span class="grade-badge">{{ student.average_grade ?? 0 }}%</span>
                        </td>
                        <td>
                            <span class="attendance-badge">{{ student.attendance_percentage ?? 0 }}%</span>
                        </td>
                        <td class="action-buttons">
                            <a href="/student-record-system/public/edit.php?id={{ student.id }}" class="btn btn-sm btn-warning">Edit</a>
                            <button class="btn btn-sm btn-danger" onclick="deleteStudent({{ student.id }}, '{{ student.first_name }} {{ student.last_name }}')">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            No students found. <a href="/student-record-system/public/add_student.php">Add your first student</a>
        </div>
        {% endif %}
    </div>

    <!-- Recent Grades -->
    <div class="section">
        <h2>Recent Grades</h2>
        {% if grades|length > 0 %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Subject</th>
                        <th>Semester</th>
                        <th>Marks</th>
                        <th>Percentage</th>
                        <th>Grade</th>
                        <th>Exam Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for grade in grades|slice(0, 10) %}
                    <tr>
                        <td>{{ grade.student_name }}</td>
                        <td>{{ grade.subject }}</td>
                        <td>{{ grade.semester }}</td>
                        <td>{{ grade.marks_obtained }}/{{ grade.total_marks }}</td>
                        <td>{{ grade.percentage }}%</td>
                        <td><span class="grade-badge">{{ grade.grade }}</span></td>
                        <td>{{ grade.exam_date }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <a href="#" class="btn btn-secondary btn-small">View All Grades</a>
        {% else %}
        <div class="alert alert-info">
            No grades recorded yet. <a href="/student-record-system/public/add_grade.php">Add a grade</a>
        </div>
        {% endif %}
    </div>

    <!-- Recent Attendance -->
    <div class="section">
        <h2>Recent Attendance</h2>
        {% if attendance|length > 0 %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in attendance|slice(0, 10) %}
                    <tr>
                        <td>{{ record.student_name }}</td>
                        <td>{{ record.attendance_date }}</td>
                        <td>
                            <span class="badge badge-{{ record.status|lower }}">
                                {{ record.status }}
                            </span>
                        </td>
                        <td>{{ record.remarks ?? '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <a href="#" class="btn btn-secondary btn-small">View All Attendance</a>
        {% else %}
        <div class="alert alert-info">
            No attendance records yet. <a href="/student-record-system/public/add_attendance.php">Mark attendance</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
function deleteStudent(studentId, studentName) {
    if (confirm(`Are you sure you want to delete ${studentName}? This will also delete all associated grades and attendance records.`)) {
        // Create a hidden form to submit POST request with CSRF token
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/student-record-system/public/delete.php?type=student&id=${studentId}`;
        
        // Get CSRF token from the page (if it exists)
        const csrfTokenElement = document.querySelector('[name="csrf_token"], [name="_token"]');
        if (csrfTokenElement) {
            const tokenInput = document.createElement('input');
            tokenInput.type = 'hidden';
            tokenInput.name = csrfTokenElement.name;
            tokenInput.value = csrfTokenElement.value;
            form.appendChild(tokenInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
