{% extends "base.html.twig" %}

{% block title %}Add Grade - Student Record Management System{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Add Grade</h2>
    
    {% if errors is not empty %}
    <div class="alert alert-danger">
        <h4>Please fix the following errors:</h4>
        <ul>
            {% for field, error in errors %}
            <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="POST" class="form-group">
        <input type="hidden" name="{{ csrf_token_name }}" value="{{ csrf_token }}" />
        <div class="form-row">
            <div class="form-col">
                <label for="student_id">Student *</label>
                <select id="student_id" name="student_id" required class="form-control" onchange="updateStudentInfo()">
                    <option value="">Select Student</option>
                    {% for student in students %}
                    <option value="{{ student.id }}">{{ student.roll_number }} - {{ student.first_name }} {{ student.last_name }}</option>
                    {% endfor %}
                </select>
                <span class="error-message" id="student_id_error"></span>
            </div>
            <div class="form-col">
                <label for="subject">Subject *</label>
                <input type="text" id="subject" name="subject" 
                       value="{{ old_subject ?? '' }}" required 
                       class="form-control" placeholder="e.g., Mathematics">
                <span class="error-message" id="subject_error"></span>
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label for="semester">Semester</label>
                <select id="semester" name="semester" class="form-control">
                    <option value="">Select Semester</option>
                    <option value="Semester 1" {% if old_semester == 'Semester 1' %}selected{% endif %}>Semester 1</option>
                    <option value="Semester 2" {% if old_semester == 'Semester 2' %}selected{% endif %}>Semester 2</option>
                </select>
            </div>
            <div class="form-col">
                <label for="exam_date">Exam Date</label>
                <input type="date" id="exam_date" name="exam_date" 
                       value="{{ old_exam_date ?? today }}" class="form-control">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label for="marks_obtained">Marks Obtained *</label>
                <input type="number" id="marks_obtained" name="marks_obtained" 
                       value="{{ old_marks_obtained ?? '' }}" required 
                       min="0" step="0.01" class="form-control" 
                       placeholder="e.g., 85" onchange="calculatePercentage()">
                <span class="error-message" id="marks_obtained_error"></span>
            </div>
            <div class="form-col">
                <label for="total_marks">Total Marks</label>
                <input type="number" id="total_marks" name="total_marks" 
                       value="{{ old_total_marks ?? 100 }}" 
                       min="1" step="0.01" class="form-control" 
                       placeholder="100" onchange="calculatePercentage()">
            </div>
        </div>

        <div class="form-row">
            <div class="form-col">
                <label for="percentage">Percentage</label>
                <input type="number" id="percentage" name="percentage" 
                       value="{{ old_percentage ?? '' }}" 
                       min="0" max="100" step="0.01" class="form-control" 
                       placeholder="Calculated automatically" readonly>
            </div>
            <div class="form-col">
                <label for="grade">Grade</label>
                <input type="text" id="grade" name="grade" 
                       value="{{ old_grade ?? '' }}" 
                       class="form-control" placeholder="Calculated automatically" readonly>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Add Grade</button>
            <a href="/fullstack2/student-record-system/public/index.php" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
function calculatePercentage() {
    const marksObtained = parseFloat(document.getElementById('marks_obtained').value) || 0;
    const totalMarks = parseFloat(document.getElementById('total_marks').value) || 100;
    
    if (totalMarks > 0) {
        const percentage = (marksObtained / totalMarks) * 100;
        document.getElementById('percentage').value = percentage.toFixed(2);
        
        // Calculate grade
        let grade = 'F';
        if (percentage >= 95) grade = 'A+';
        else if (percentage >= 90) grade = 'A';
        else if (percentage >= 85) grade = 'B+';
        else if (percentage >= 80) grade = 'B';
        else if (percentage >= 75) grade = 'B-';
        else if (percentage >= 70) grade = 'C+';
        else if (percentage >= 65) grade = 'C';
        else if (percentage >= 60) grade = 'C-';
        else if (percentage >= 55) grade = 'D+';
        else if (percentage >= 50) grade = 'D';
        
        document.getElementById('grade').value = grade;
    }
}

function updateStudentInfo() {
    // Could be enhanced to fetch and display additional student info
}
</script>
{% endblock %}
